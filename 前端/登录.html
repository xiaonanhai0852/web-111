<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½• - å…ƒå™¨ä»¶ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 400px;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5568d3;
        }

        .alert {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }
        
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            background: #f0f0f0;
            color: #666;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h1>ğŸ”§ å…ƒå™¨ä»¶ç®¡ç†ç³»ç»Ÿ</h1>

        <div class="alert" id="alert"></div>

        <!-- åˆ‡æ¢ç™»å½•/æ³¨å†Œ -->
        <div class="mode-selector" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button type="button" class="mode-btn active" onclick="switchMode('login')">ç™»å½•</button>
            <button type="button" class="mode-btn" onclick="switchMode('register')">æ³¨å†Œ</button>
        </div>

        <!-- ç™»å½•è¡¨å• -->
        <div id="login-section">
            <form id="login-form">
                <div class="form-group">
                    <label>ç”¨æˆ·åï¼š</label>
                    <input type="text" id="username" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>

                <div class="form-group">
                    <label>å¯†ç ï¼š</label>
                    <input type="password" id="password" required placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>

                <button type="submit">ç™»å½•</button>
            </form>
        </div>

        <!-- æ³¨å†Œè¡¨å• -->
        <div id="register-section" style="display: none;">
            <p style="text-align: center; color: #666; margin-bottom: 20px;">æ³¨å†Œä¸ºæ™®é€šç”¨æˆ·</p>

            <form id="register-form">
                <div class="form-group">
                    <label>å­¦å·/å·¥å·ï¼š</label>
                    <input type="text" id="reg-student-id" required>
                </div>

                <div class="form-group">
                    <label>çœŸå®å§“åï¼š</label>
                    <input type="text" id="reg-real-name" required>
                </div>

                <div class="form-group">
                    <label>ç”¨æˆ·åï¼š</label>
                    <input type="text" id="reg-username" required>
                </div>

                <div class="form-group">
                    <label>å¯†ç ï¼š</label>
                    <input type="password" id="reg-password" required minlength="6">
                </div>

                <div class="form-group">
                    <label>ç¡®è®¤å¯†ç ï¼š</label>
                    <input type="password" id="reg-password-confirm" required minlength="6">
                </div>

                <div class="form-group">
                    <label>é‚®ç®±ï¼š</label>
                    <input type="email" id="reg-email" required>
                </div>

                <div class="form-group">
                    <label>æ‰‹æœºå·ï¼š</label>
                    <input type="text" id="reg-phone" required pattern="[0-9]{11}">
                </div>

                <div class="form-group">
                    <label>éƒ¨é—¨ï¼š</label>
                    <input type="text" id="reg-department">
                </div>

                <button type="submit">æ³¨å†Œ</button>
            </form>
        </div>
    </div>
    
    <script>
        let currentMode = 'login';

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ¨¡å¼
        function switchMode(mode) {
            currentMode = mode;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // åˆ‡æ¢æ˜¾ç¤ºçš„è¡¨å•
            if (mode === 'login') {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('register-section').style.display = 'none';
            } else {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('register-section').style.display = 'block';
            }

            // æ¸…ç©ºæç¤º
            document.getElementById('alert').style.display = 'none';
        }

        // ç™»å½•è¡¨å•æäº¤
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('http://localhost:8080/api/user/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°localStorage
                    const userInfo = {
                        username: result.data.studentId,
                        realName: result.data.realName,
                        role: result.data.role,
                        loginTime: new Date().toISOString()
                    };
                    localStorage.setItem('userInfo', JSON.stringify(userInfo));

                    showAlert('ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');

                    setTimeout(() => {
                        window.location.href = 'å…ƒå™¨ä»¶ç®¡ç†.html';
                    }, 1000);
                } else {
                    showAlert(result.message || 'ç™»å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showAlert('ç™»å½•å¤±è´¥ï¼š' + error.message, 'error');
            }
        });

        // æ³¨å†Œè¡¨å•æäº¤
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const studentId = document.getElementById('reg-student-id').value;
            const realName = document.getElementById('reg-real-name').value;
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const passwordConfirm = document.getElementById('reg-password-confirm').value;
            const email = document.getElementById('reg-email').value;
            const phone = document.getElementById('reg-phone').value;
            const department = document.getElementById('reg-department').value;

            // éªŒè¯å¯†ç 
            if (password !== passwordConfirm) {
                showAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('å¯†ç é•¿åº¦è‡³å°‘6ä½ï¼', 'error');
                return;
            }

            // éªŒè¯æ‰‹æœºå·
            if (!/^[0-9]{11}$/.test(phone)) {
                showAlert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ï¼', 'error');
                return;
            }

            // æ„å»ºæ³¨å†Œæ•°æ®
            const registerData = {
                studentId: studentId,
                realName: realName,
                username: username,
                password: password,
                email: email,
                phone: phone,
                role: 'USER', // åªèƒ½æ³¨å†Œä¸ºæ™®é€šç”¨æˆ·
                department: department || ''
            };

            console.log('æ³¨å†Œæ•°æ®:', registerData);

            // è°ƒç”¨åç«¯APIæ³¨å†Œ
            try {
                const response = await fetch('http://localhost:8080/api/user/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('æ³¨å†ŒæˆåŠŸï¼è¯·ä½¿ç”¨æ–°è´¦å·ç™»å½•', 'success');

                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('register-form').reset();

                    // 2ç§’ååˆ‡æ¢åˆ°ç™»å½•é¡µé¢
                    setTimeout(() => {
                        switchModeDirectly('login');
                    }, 2000);
                } else {
                    showAlert(result.message || 'æ³¨å†Œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showAlert('æ³¨å†Œå¤±è´¥ï¼š' + error.message, 'error');
            }
        });

        // ç›´æ¥åˆ‡æ¢æ¨¡å¼ï¼ˆä¸é€šè¿‡eventï¼‰
        function switchModeDirectly(mode) {
            currentMode = mode;

            document.querySelectorAll('.mode-btn').forEach((btn, index) => {
                if ((mode === 'login' && index === 0) || (mode === 'register' && index === 1)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            if (mode === 'login') {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('register-section').style.display = 'none';
            } else {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('register-section').style.display = 'block';
            }
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert ' + type;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>

